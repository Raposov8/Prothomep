@page "{id}"
@model SGID.Pages.Estoque.FormularioAvulsoModel
@{
    ViewData["Title"] = "Avulso";
    if (User.IsInRole("Diretoria") && !User.IsInRole("Admin"))
    {
        Layout = "_LayoutDiretoria";
    }
    else
    {
        Layout = "_LayoutGeral";
    }
}

<div class="row">
    <div class="col-md-6">
        <h2 style="padding-left:20px;">Formulario Avulso</h2>
    </div>
</div>

@Html.AntiForgeryToken()

@using (@Html.BeginForm(FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    <div class="row">
        <div class="card" style="padding:10px;">
            <div class="col-md-12">
                <input hidden id="Empresa" name="Empresa">
                <div class="row">
                    <div class="form-group col-md-4">
                        <label class="Label">Cliente</label>
                        <input class="form-control" id="Cliente" name="Cliente">
                    </div>
                    <div class="form-group col-md-3">
                        <label class="Label">Data Cirurgia</label>
                        <input type="datetime-local" class="form-control" id="DataCirurgia" name="DataCirurgia" />
                    </div>
                    <div class="form-group col-md-3">
                        <label class="Label">Paciente</label>
                        <input type="text" class="form-control" id="Paciente" name="Paciente">
                    </div>
                    <div class="form-group col-md-2">
                        <label class="Label">Cirurgião</label>
                        <input class="form-control" id="Medico" name="Medico" />
                    </div>
                    <div class="form-group col-md-4">
                        <label class="Label">Convênio</label>
                        <input class="form-control" id="Convenio" name="Convenio">
                    </div>
                    <div class="form-group col-md-4">
                        <label class="Label">Representante</label>
                        <input class="form-control" id="Representante" name="Representante">
                    </div>
                    <div class="form-group col-md-2">
                        <label class="Label">Nº Agendamento</label>
                        <input type="text" class="form-control" id="NumAgendamento" name="NumAgendamento" />
                    </div>
                </div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-body">
                <table id="Produto" name="Produto" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th class="text-center">
                                Item
                            </th>
                            <th class="text-center">
                                Produto
                            </th>
                            <th class="text-center">
                                Descrição
                            </th>
                            <th class="text-center">
                                QTDE
                            </th>
                            <th class="text-center">
                                Lote
                            </th>
                            <th class="text-center">
                                <a class="details" data-id="10" data-toggle="modal" data-target="#details-modal"><i class="fa-solid fa-circle-plus" style="color:green"></i></a>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row justify-content-center">
            <div style="color:#00b050" class="col-md-2"><button class="btn btn-button btn-success float-end" style="font-size:12px;" type="submit"><i class="fa-solid fa-thumbs-up"></i> Imprimir</button></div> |
            <div style="color:#c00000" class="col-md-2"><a class="btn btn-button btn-danger" style="font-size:12px;" href="/dashboard/0"><i class="fa-solid fa-xmark"></i> Cancelar</a></div>
        </div>
    </div>
}

<div class="modal fade" id="details-modal" role="dialog" tabindex="-1" aria-labelledby="demo-default-modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!--Modal header-->
            <div class="modal-header">
                <div class="col-md-12">
                    <h4>Buscar Item</h4>
                </div>
            </div>

            <!--Modal body-->
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <label>Codigo Produto</label>
                        <select type="text" class="form-control" id="CodProd" name="CodProd" >
                            @foreach(var data in Model.Codigos){
                                <option value="@data">@data</option>
                            }
                        </select>
                    </div>
                </div>
            </div>

            <!--Modal footer-->
            <div class="modal-footer">
                <div class="col-md-12">
                    <button class="btn btn-button btn-success float-end" id="Adicionar">
                        Adicionar Item
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script>
        var count = 0;
        var item = 1;
        $(document).ready(function(){

            $("#Empresa").val(`@ViewContext.RouteData.Values["id"]`)

            remove = function (item) {

                var tr = $(item).closest('tr');

                tr.fadeOut(400, function () {
                    tr.remove();

                    count = 0;

                    var valor = $("#Produto>tbody").find("tr");

                    valor.each(function () {

                        var tds = $(this).find("td");

                        tds.each(function () {
                            var input = $(this).find("input")[0];
                            if (input != undefined) {

                                var id = input.id.split('.')[1];
                                var name = input.name.split('.')[1];

                                input.id = `Produtos[${count}].${id}`;
                                input.name = `Produtos[${count}].${name}`;
                            }
                        })
                        count++
                    })
                });

                return false;
            }

            $('a.details').on('click', function () {
                $('#details-modal').modal('show')
            });

            $('a.close').on('click',function(){
                $('#details-modal').modal('hide')
            })

            $("#Adicionar").click(function() {
                var codigo =  $("#CodProd").val();
                var empresa = $("#Empresa").val();
                var chamadaUrl = `/estoque/formularioavulso/01?handler=AdicionarProd&&Codigo=${codigo}&&Empresa=${empresa}`
                $.ajax({
                    url: chamadaUrl,
                    type: "POST",
                    contentType: "application/json;",
                    dataType: 'json',
                    headers: {
                        "RequestVerificationToken": $('input:hidden[name="__RequestVerificationToken"]').val()
                    },
                    success: function(data) {

                        if (data != "") {
                            
                                    var linha = `<tr>
                                        <td>
                                           ${item}
                                        </td>
                                        <td>
                                           ${data.item}
                                           <input type="hidden" id="Produtos[${count}].Item" name="Produtos[${count}].Item" value="${data.item}" />
                                        </td>
                                        <td>
                                            ${data.produtos}
                                            <input type="hidden" id="Produtos[${count}].Produtos" name="Produtos[${count}].Produtos" value="${data.produtos}" />
                                        </td>
                                        <td>
                                           <input type="number" id="Produtos[${count}].Und" min="0" name="Produtos[${count}].Und" value="${data.und}" />
                                        </td>
                                        <td>
                                            <input type="text" id="Produtos[${count}].Lote" name="Produtos[${count}].Lote" />
                                        </td>
                                        <td>
                                           <a class="fa-regular fa-trash-can add-tooltip" onclick="remove(this)" style="text-decoration:none;" id="Excluir" data-container="body" data-placement="top" data-original-title="Excluir Recurso" aria-hidden="true"></a>
                                        </td>
                                        </tr>`;
                                    count++;
                                    item++;
                                    
                                    $("#Produto>tbody").append(linha);

                        }
                        else
                        {
                            alert("Produto não existe")
                        }
                    }
                })
            })
        })
    </script>
}
