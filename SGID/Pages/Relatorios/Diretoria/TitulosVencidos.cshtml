@page
@model SGID.Pages.Relatorios.Diretoria.TitulosVencidosModel
@{
    ViewData["Title"] = "Titulos Vencidos Denuo";
    if (User.IsInRole("Diretoria") && !User.IsInRole("Admin"))
    {
        Layout = "_LayoutDiretoria";
    }
    else
    {
        Layout = "_LayoutNovo";
    }
}

<div class="row justify-content-center">
    <div class="col-md-6">
        <div id="GraficoAberto" style="height:300px;"></div>
    </div>
</div>

@using (@Html.BeginForm(FormMethod.Post))
{
    <div class="row">
        <div class="form-group mx-sm-3 mb-2 col-lg-3">
            <label>Cliente</label>
            <select type="text" class="form-control" id="NReduz" name="NReduz" placeholder="Cliente">
                <option value="">TODOS....</option>
                @foreach (var data in Model.Clientes)
                {
                    <option value="@data">@data</option>
                }
            </select>
        </div>
        <div class="form-group mx-sm-3 mb-2 col-lg-3">
            <label>Época</label>
            <select type="text" class="form-control" id="Tempo" name="Tempo" placeholder="Cliente">
                <option value="1">DEPOIS 2022</option>
                <option value="2">ANTES 2023</option>
                <option value="">TODOS....</option>
            </select>
        </div>
        <div class="form-group mx-sm-3 mb-2 col-lg-3">
            <label>Tipo</label>
            <select type="text" class="form-control" id="Revelia" name="Revelia" placeholder="Cliente">
                <option value="">TODOS....</option>
                <option value="Revelia">Revelia</option>
                <option value="Padrão">Padrão</option>
            </select>
        </div>

        <div class="form-group mx-sm-3 mb-2 col-lg-1">
            <button type="submit" class="btn btn-primary mb-2">Pesquisar</button>
        </div>
        <div class="form-group mx-sm-3 mb-2 col-lg-1">
            <button type="submit" class="btn btn-secondary mb-2" asp-page-handler="Export"><i class="fa-solid fa-file-excel"></i> Exportar Excel</button>
        </div>
    </div>
}


<div class="panel">
    <div class="panel-body">
        <table id="demo-dt-addrow" class="table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th class="text-center">
                        Cliente
                    </th>
                    <th class="text-center">
                        NF
                    </th>
                    <th class="text-center">
                        Data Emissão
                    </th>
                    <th class="text-center">
                        Data de Vencimento
                    </th>
                    <th class="text-center">
                        Valor Original
                    </th>
                    <th class="text-center">
                        Saldo Devedor
                    </th>
                    <th class="text-center">
                        Tipo Faturamento
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var data in Model.Relatorio)
                {
                    <tr>
                        <td>@Html.DisplayFor(model => data.Cliente)</td>
                        <td>@Html.DisplayFor(model => data.NF)</td>
                        <td>@Html.DisplayFor(model => data.DataEmissao)</td>
                        <td>@Html.DisplayFor(model => data.DataVencimento)</td>
                        <td>@string.Format("{0:N2}", data.Valor)</td>
                        <td>@string.Format("{0:N2}", data.ValorSaldo)</td>
                        <td>@Html.DisplayFor(model => data.Revelia)</td>
                    </tr>
                }
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>Total:</td>
                    <td>@string.Format("{0:N2}", Model.Relatorio.Sum(x => x.Valor))</td>
                    <td>@string.Format("{0:N2}", Model.Relatorio.Sum(x => x.ValorSaldo))</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>


@section scripts
{
    <script>
        $(document).ready(function () {
            var NReduz = '@Model.Cliente'.replace('&#xC7;', 'Ç').replace('&#xC3;', 'Ã').replace('&#xD5;', 'Õ')
            $('#NReduz').val(NReduz);

            var Tempo = '@Model.Tempo'.replace('&#xC7;', 'Ç').replace('&#xC3;', 'Ã').replace('&#xD5;', 'Õ')
            $('#Tempo').val(Tempo);

            var Revelia = '@Model.Revelia'.replace('&#xC7;', 'Ç').replace('&#xC3;', 'Ã').replace('&#xD5;', 'Õ')
            $('#Revelia').val(Revelia);
        })
    </script>
    <script>
        $(document).ready(function () {

            google.charts.load('current', { 'packages': ['corechart'] });
            google.charts.setOnLoadCallback(drawChart);

            var grafico = [];

            grafico.push(['Clientes', 'Valor']);

            function drawChart() {

                var data = new google.visualization.arrayToDataTable(
                    grafico
                );

                var options = {
                    title: 'Titulos Vencidos',
                    legend: { position: "none" },

                };

                var chart = new google.visualization.PieChart(document.getElementById('GraficoAberto'));


                chart.draw(data, options);
            }


            grafico = [];

            grafico.push(['Clientes', 'Valor']);

            @foreach (var data in Model.Relatorio.GroupBy(x=> x.Cliente).Select(x=> new{ x.Key,Valor = x.Sum(c=> c.Valor)}).OrderBy(c=>c.Valor).ToList())
            {

                @:grafico.push(['@data.Key', @data.Valor])

            }

            drawChart()

        })
    </script>
}
