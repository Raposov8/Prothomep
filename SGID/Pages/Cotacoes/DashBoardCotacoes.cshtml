@page "{id}"
@model SGID.Pages.Cotacoes.DashBoardCotacoesModel
@{
    ViewData["Title"] = "DASHBOARD";
    if (User.IsInRole("Diretoria") && !User.IsInRole("Admin"))
    {
        Layout = "_LayoutDiretoria";
    }
    else
    {
        Layout = "_LayoutNovo";
    }
}


<div class="row justify-content-center">
    <div class="col-sm-4 col-md-4">
        <div class="panel panel-colorful" style="background-color:lightgray">
            <div class="panel-heading">
                <h2 style="margin:0%;color:#00b050" class="panel-title text-center">RESPONDIDAS</h2>
            </div>
            <div class="panel-body" style="padding-top:0px;">
                <a class="produto" href="/cotacoes/dashboardcotacoes/1"><h3 class="text-center" style="margin-top:0%; color:#00b050;font-size:80px">@Model.Respondidas</h3></a>
            </div>
        </div>
    </div>
    <div class="col-sm-4 col-md-4">
        <div class="panel panel-colorful" style="background-color:lightgray">
            <div class="panel-heading">
                <h2 style="margin:0%;color:#c00000" class="panel-title text-center">NÃO RESPONDIDAS</h2>
            </div>
            <div class="panel-body" style="padding-top:0px;">
                <a class="produto" href="/cotacoes/dashboardcotacoes/0"><h3 class="text-center" style="margin-top:0%; color:#c00000;font-size:80px">@Model.NRespondidas</h3></a>
            </div>
        </div>
    </div>
    <div class="col-sm-4 col-md-4">
        <div class="panel panel-colorful" style="background-color:lightgray">
            <div class="panel-heading">
                <h2 style="margin:0%;" class="panel-title text-center">AGENDAR</h2>
            </div>
            <div class="panel-body" style="padding-top:0px;">
                <a class="produto" href="/cotacoes/dashboardcotacoes/2"><h3 class="text-center" style="margin-top:0%;font-size:80px">@Model.Aprovadas</h3></a>
            </div>
        </div>
    </div>
    <div class="col-sm-4 col-md-4">
        <div class="panel panel-colorful" style="background-color:lightgray">
            <div class="panel-heading">
                <h2 style="margin:0%;" class="panel-title text-center">PENDENTE ESTOQUE</h2>
            </div>
            <div class="panel-body" style="padding-top:0px;">
                <a class="produto" href="/cotacoes/dashboardcotacoes/4"><h3 class="text-center" style="margin-top:0%;font-size:80px">@Model.AguardandoConfirmacao</h3></a>
            </div>
        </div>
    </div>
    <div class="col-sm-4 col-md-4">
        <div class="panel panel-colorful" style="background-color:lightgray">
            <div class="panel-heading">
                <h2 style="margin:0%;" class="panel-title text-center">RESPONDIDO ESTOQUE</h2>
            </div>
            <div class="panel-body" style="padding-top:0px;">
                <a class="produto" href="/cotacoes/dashboardcotacoes/5"><h3 class="text-center" style="margin-top:0%;font-size:80px">@Model.RespondidasEstoque</h3></a>
            </div>
        </div>
    </div>
</div>


<div class="panel">
    <div class="panel-body">
        <table id="demo-dt-addrow" class="table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
                <tr>
                    @if (User.IsInRole("Admin") || User.IsInRole("Diretoria"))
                    {
                        <th class="text-center">
                            Empresa
                        </th>
                    }
                    @if (User.IsInRole("Admin") || User.IsInRole("GestorComercial") || User.IsInRole("Diretoria"))
                    {
                        <th class="text-center">
                            Vendedor
                        </th>
                    }
                    <th class="text-center">
                        Data Alteração
                    </th>
                    <th class="text-center">
                        Cod. Reserva
                    </th>
                    <th class="text-center">
                        Paciente
                    </th>
                    <th class="text-center">
                        Cliente
                    </th>
                    <th class="text-center">
                        Hospital
                    </th>
                    <th class="text-center">
                        Data Cotação
                    </th>
                    <th class="text-center">
                        Nº Cotação
                    </th>
                    <th class="text-center">
                        Status Cotação
                    </th>
                    <th class="text-center">
                        Nº Pedido
                    </th>
                    <th class="text-center">
                        Status Pedido
                    </th>
                    <th class="text-center">
                        Ação
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var data in Model.Agendamentos)
                {
                    <tr>
                        @if (User.IsInRole("Admin") || User.IsInRole("Diretoria"))
                        {
                            <td>
                                @if (data.Empresa == "01")
                                {
                                    <span>INTERMEDIC</span>
                                }
                                else
                                {
                                    <span>DENUO</span>
                                }
                            </td>
                        }
                        @if (User.IsInRole("Admin") || User.IsInRole("GestorComercial") || User.IsInRole("Diretoria"))
                        {
                            <td>
                                @data.Vendedor
                            </td>
                        }
                        <td>@data.DataAlteracao.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@Html.DisplayFor(model=> data.Empresa)</td>
                        <td>@Html.DisplayFor(model=> data.Paciente)</td>
                        <td>@Html.DisplayFor(model=> data.Cliente)</td>
                        <td>@Html.DisplayFor(model=> data.Hospital)</td>
                        @if(data.DataCotacao == null)
                        {
                            <td>Não há registro</td>
                        }
                        else
                        {
                            <td>@data.DataCotacao.Value.ToString("dd/MM/yyyy HH:mm")</td>
                        }
                        <td>@Html.DisplayFor(model=> data.Id)</td>
                        @if (data.StatusCotacao == 0 && data.StatusPedido == 0)
                        {
                            <td>Não Enviado</td>
                        }
                        else if (data.StatusCotacao == 0)
                        {
                            <td>Não Respondida</td>
                        }
                        else
                        {
                            <td>Respondida</td>
                        }
                        <td>@Html.DisplayFor(model=> data.Id)</td>
                        @if (data.StatusPedido == 0)
                        {
                            <td>Sem Cotação</td>
                        }
                        else if (data.StatusPedido == 1)
                        {
                            <td>Ag. Cotação</td>
                        }
                        else
                        {
                            <td>Confirmado</td>
                        }
                        <td>
                            @if (data.StatusCotacao == 0)
                            {
                                <a class="details" href="/cotacoes/aceitarcotacoes/@data.Id"><i class="fa-solid fa-circle-plus" style="color:green"></i></a>
                                
                                <a class="rejeicao" data-id="@data.Id"><i class="fa-regular fa-circle-xmark" style="color:red"></i></a>
                            }
                            @if (data.StatusCotacao == 1 && data.StatusPedido != 3 && data.StatusPedido != 7)
                            {
                                <a href="/cotacoes/aceitarcotacoes/@data.Id" class="fa-solid fa-pen add-tooltip" style="text-decoration:none;" data-container="body" data-placement="top" data-original-title="Editar Cotação" aria-hidden="true"></a>

                                <a onclick="dados(@data.Id)" class="fas fa-eye add-tooltip" style="text-decoration:none;" data-container="body" data-placement="top" data-original-title="Visualizar Cotação" aria-hidden="true"></a>

                                <a class="rejeicao" data-id="@data.Id"><i class="fa-regular fa-circle-xmark" style="color:red"></i></a>
                            }
                            @if (data.StatusPedido == 3 || data.StatusPedido == 7)
                            {
                                <a href="/cotacoes/ConfirmarCotacoes/@data.Id" class="fa-solid fa-pen add-tooltip" style="text-decoration:none;" data-container="body" data-placement="top" data-original-title="Confirmar Cotação" aria-hidden="true"></a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


<!--Rejeicao-->
<div class="modal fade" id="rejeicao-modal" role="dialog" tabindex="-1" aria-labelledby="demo-default-modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!--Modal header-->
            <div class="modal-header">
                <div class="col-md-12">
                    <h4>Selecionar Produto</h4>
                </div>
            </div>

            <!--Modal body-->
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <input hidden id="RejeicaoId" name="RejeicaoId" />
                        <label>Motivo</label>
                        <select type="text" class="form-control" id="MotRejeicao" name="MotRejeicao">
                            @foreach (var data in Model.Rejeicoes)
                            {
                                <option value="@data.Motivo">@data.Motivo</option>
                            }
                        </select>
                    </div>
                    <br />
                    <div class="col-md-12">
                        <label>Observação</label>
                        <textarea type="text" class="form-control" id="ObsRejeicao" name="ObsRejeicao">
                        </textarea>
                    </div>
                </div>
            </div>

            <!--Modal footer-->
            <div class="modal-footer">
                <div class="col-md-12">
                    <button class="btn btn-button btn-success float-end" onclick="recusa(1)">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Loading-->
<div class="modal fade" id="loading-modal" role="dialog" tabindex="-1" aria-labelledby="demo-default-modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!--Modal body-->
            <div class="modal-body">
                <div style="display:flex; justify-content: center;">
                    <i class="fa-solid fa-spinner fa-10x fa-spin-pulse"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Descricao-->
<div class="modal fade" id="descricao-modal" role="dialog" tabindex="-1" aria-labelledby="demo-default-modal" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <!--Modal header-->
            <div class="modal-header">
                <div class="col-md-1">
                    <a class="close" data-dismiss="modal"><i class="fa-regular fa-circle-xmark" style="color:red"></i></a>
                </div>
            </div>
            <!--Modal body-->
            <div class="modal-body">
                <div class="row">
                    <div class="card" style="padding:10px;">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="form-group col-md-3">
                                    <label class="Label">Empresa</label>
                                    <select class="form-control" id="Empresa" name="Empresa">
                                        <option value="03">Denuo</option>
                                        <option value="01">Intermedic</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="Label">Cliente Faturamento</label>
                                    <input class="form-control" id="Cliente" name="Cliente" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="Label">Condições de Pagto.</label>
                                    <input type="text" class="form-control" id="CondPag" name="CondPag" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="Label">Tabela (R$)</label>
                                    <input class="form-control" id="Tabela" name="Tabela" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="Label">Médico</label>
                                    <input type="text" class="form-control" id="Medico" name="Medico" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="Label">Vendedor</label>
                                    <input type="text" class="form-control" id="Vendedor" name="Vendedor" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="Label">Matricula</label>
                                    <input type="text" class="form-control" id="Matricula" name="Matricula" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="Label">Paciente</label>
                                    <input type="text" class="form-control" id="Paciente" name="Paciente" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group col-md-3">
                                    <label class="Label">Hospital</label>
                                    <input type="text" class="form-control" id="Hospital" name="Hospital" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="Label">Convênio</label>
                                    <input type="text" class="form-control" id="Convenio" name="Convenio" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="Label">Instrumentador</label>
                                    <input class="form-control" id="Instrumentador" name="Instrumentador" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label class="Label">Procedimento</label>
                                    <input class="form-control" id="Procedimento" name="Procedimento" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group col-md-2">
                                    <label class="Label">Autorizado ?</label>
                                    <select class="form-control" id="Autorizado" name="Autorizado">
                                        <option value="1">SIM</option>
                                        <option value="2">NÃO</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-2">
                                    <label class="Label">Data Cirurgia</label>
                                    <input type="text" class="form-control" id="DataAgendamento" name="DataAgendamento" />
                                </div>
                                <div class="form-group col-md-2">
                                    <label class="Label">Data Autorização</label>
                                    <input type="text" class="form-control" id="DataAutorizacao" name="DataAutorizacao" />
                                </div>
                                <div class="form-group col-md-2">
                                    <label style="font-size:10px;">Nº Autorização</label>
                                    <input type="text" class="form-control" id="NumAutorizacao" name="NumAutorizacao" />
                                </div>
                                <div class="form-group col-md-2">
                                    <label class="Label">Senha</label>
                                    <input type="text" class="form-control" id="Senha" name="Senha" />
                                </div>
                                <div class="form-group col-md-2">
                                    <label class="Label">Tipo</label>
                                    <select class="form-control" id="Tipo" name="Tipo">
                                        <option value="2">ELETIVA</option>
                                        <option value="3">EMERGENCIA</option>
                                        <option value="1">URGENTE</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">

                                <div class="form-group col-md-12">
                                    <label class="Label">Observação</label>
                                    <input type="text" class="form-control" id="Obs" name="Obs" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--Modal footer-->
                <div class="modal-footer" style="padding-left:20px;">
                    <div class="panel">
                        <div class="panel-body">
                            <table id="Produto" name="Produto" class="table-striped table-bordered" cellspacing="0" width="100%">
                                <thead>
                                    <tr>
                                        <th class="text-center">
                                            Item
                                        </th>
                                        <th class="text-center">
                                            Licit.
                                        </th>
                                        <th class="text-center">
                                            Produto
                                        </th>
                                        <th class="text-center">
                                            Tuss
                                        </th>
                                        <th class="text-center">
                                            Anvisa
                                        </th>
                                        <th class="text-center">
                                            Marca
                                        </th>
                                        <th class="text-center">
                                            Qtd.
                                        </th>
                                        <th class="text-center">
                                            UM
                                        </th>
                                        <th class="text-center">
                                            Prc. Unit.
                                        </th>
                                        <th class="text-center">
                                            Vlr.Total
                                        </th>
                                        <th class="text-center">
                                            Tp. Op.
                                        </th>
                                        <th class="text-center">
                                            Lote
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-body">
                            <table id="Patrimonio" name="Patrimonio" class="table table-striped table-bordered" cellspacing="0" width="100%">
                                <thead>
                                    <tr>
                                        <th class="text-center">
                                            Descri
                                        </th>
                                        <th class="text-center">
                                            KitBas
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>
         $(function () {

            $('a.close').on('click', function () {
                $('#details-modal').modal('hide')
                $('#dados-modal').modal('hide')
                $('#envio-modal').modal('hide')
                $('#itens-modal').modal('hide')
                $('#rejeicao-modal').modal('hide')
                $('#loading-modal').modal('hide')
                $('#descricao-modal').modal('hide')
            })

            $("a.rejeicao").on('click', function () {
                var id = $(this).data('id')
                $("#RejeicaoId").val(id)
                $('#rejeicao-modal').modal('show')
            })

            dados = function (id) {

                $('#loading-modal').modal('show');
                var chamadaUrl = `/cirurgias/agendamentos?handler=details&&id=${id}`
                $.ajax({
                    url: chamadaUrl,
                    type: "GET",
                    contentType: "application/json;",
                    dataType: 'json',
                    headers: {
                        "RequestVerificationToken": $('input:hidden[name="__RequestVerificationToken"]').val()
                    },
                    success: function (data) {


                        $("#Empresa").val(data.agendamento.empresa);
                        $("#Tipo").val(data.agendamento.tipo);
                        $("#Cliente").val(data.agendamento.cliente);
                        $("#CondPag").val(data.agendamento.condPag);
                        $("#Tabela").val(data.agendamento.tabela);
                        $("#Vendedor").val(data.agendamento.vendedor);
                        $("#Medico").val(data.agendamento.medico);
                        $("#Hospital").val(data.agendamento.hospital)
                        $("#Matricula").val(data.agendamento.matricula);
                        $("#Paciente").val(data.agendamento.paciente);
                        $("#Convenio").val(data.agendamento.convenio);
                        $("#Instrumentador").val(data.agendamento.instrumentador);
                        $("#DataAgendamento").val(data.agendamento.dataCirurgia);
                        $("#DataAutorizacao").val(data.agendamento.dataAutorizacao);
                        $("#NumAutorizacao").val(data.agendamento.numAutorizacao);
                        $("#Procedimento").val(data.agendamento.procedimento)
                        $("#Senha").val(data.agendamento.senha);
                        $("#Obs").val(data.agendamento.observacao);
                        $("#Autorizado").val(data.agendamento.autorizado)

                        var produtos = data.produtos;
                        var patris = data.patris;
                        setTimeout(function () {
                            $('#loading-modal').modal('hide');
                        }, 2000)


                        $("#Produto>tbody>tr").detach()
                        produtos.forEach(function (produto) {
                            var linha = `
                                        <tr>
                                            <td>${produto.item}</td>
                                            <td>${produto.licit}</td>
                                            <td>${produto.produtos}</td>
                                            <td>${produto.tuss}</td>
                                            <td>${produto.anvisa}</td>
                                            <td>${produto.marca}</td>
                                            <td>${produto.und}</td>
                                            <td>${produto.prcUnid}</td>
                                            <td>${produto.segUnd}</td>
                                            <td>${produto.tipoOp}</td>
                                            <td>${produto.vlrTotal}</td>
                                            <td>${produto.lote}</td>
                                        </tr>
                                        `;
                            $("#Produto>tbody").append(linha);
                        })

                        $("#Patrimonio>tbody>tr").detach()
                        patris.forEach(function (patri) {
                            var linha = `<tr>
                                                        <td> ${patri.descri}</td>
                                                        <td> ${patri.kitBas}</td>
                                            </tr>`
                            $("#Patrimonio>tbody").append(linha);
                        })


                        setTimeout(function () {
                            $('#descricao-modal').modal('show');
                        }, 2000)

                    }
                })
            }

         })
    </script>
    <script>
        recusa = function (num) {
            //$('.modal-body').load(`/masterdetails/product?id=${$(this).data('id')}`);

            var id = $("#RejeicaoId").val();
            var Motivo = $("#MotRejeicao").val();
            var Obs = $("#ObsRejeicao").val();

            var chamadaUrl = `/dashboard/0?handler=RecusarPedido&&AgendamentoId=${id}&&MotivoReij=${Motivo}&&ObsReij=${Obs}`
            $.ajax({
                url: chamadaUrl,
                type: "POST",
                contentType: "application/json;",
                dataType: 'json',
                headers: {
                    "RequestVerificationToken": $('input:hidden[name="__RequestVerificationToken"]').val()
                },
                success: function (data) {

                    location.reload();

                }
            })
            return true;
        };
    </script>
}